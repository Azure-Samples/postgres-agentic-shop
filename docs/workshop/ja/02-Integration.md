# Azure Database for PostgreSQLへのAI・ベクトル・グラフ機能の統合

Azure Database for PostgreSQLを単なるリレーショナルデータベースではなく、**AI（人工知能）・機械学習（ML）・ベクトル検索・グラフデータ**を統合したプラットフォームとして活用することで、より高度なデータ検索・分析が可能になります。本セクションでは、その理由と、本ハンズオンで使用する各種拡張機能の概要および有効化手順について説明します。

## 拡張機能の概要: azure_ai、pgvector、Apache AGE

- **azure_ai拡張機能 (プレビュー)**: Azure Database for PostgreSQLのFlexibleサーバ向けに提供されている新機能で、データベース内から直接Azureの各種AIサービス（Azure OpenAIやAzure Cognitive Servicesなど）を呼び出すことを可能にします。これにより、SQLクエリの中でテキストの埋め込みベクトル生成やLLMによる文章生成・要約、テキストの分析（感情分析やキーフレーズ抽出など）が行えるようになります。言い換えると、Azureの強力なAIモデルをPostgreSQL内にシームレスに統合し、**データベースがAIの機能を直接利用できる**ようになる拡張です。azure_ai拡張をインストールすると、データベース内に専用のスキーマ（`azure_ai`や`azure_openai`、`azure_cognitive`）が作成され、そこに各種AIサービスを呼び出す関数が提供されます。例えば、`azure_openai.create_embeddings()`で埋め込みベクトルを生成したり、`azure_ai.generate()`でLLMによるテキスト生成を行ったり、`azure_ai.rank()`で文章の関連度評価（リランキング）を行うことができます。

- **pgvector拡張機能**: PostgreSQLにオープンソースの**ベクトル類似検索機能**を追加する拡張です。テキストや画像などから生成された特徴ベクトルをデータベース内にそのまま保存し、高速な近似近傍検索（ANN）が可能となります。pgvectorを使うことで、ベクトルデータベース専用の製品を使わずともPostgreSQLで埋め込みベクトルの格納・検索ができ、RDB内の他のリレーショナルデータと組み合わせたクエリも容易になります。たとえばSQLの中で特殊な演算子`<=>`を使ってベクトル間の距離（類似度）を計算することができ、あるクエリベクトルに対して最も距離の近い（＝内容が類似した）上位N件のレコードを取得するといった操作がシンプルに書けます。Azure Database for PostgreSQLではpgvector拡張がサポートされており、埋め込みベクトルとAzure OpenAIの組み合わせでRAG（Retrieval Augmented Generation）パターンが実装できます。

- **Apache AGE拡張機能**: PostgreSQLにグラフデータベースの機能を追加する拡張で、**Apache AGE (Apache Graph Extension)** と呼ばれます。Apache AGEを導入することで、PostgreSQL上でノードとエッジからなるグラフ構造を表現・保存し、**openCypherクエリ言語**でグラフに対する問い合わせが可能になります。これにより、従来はNeo4jなど専用のグラフDBを使っていたような複雑なリレーションシップの解析を、PostgreSQL一つで実現できるようになります。例えば、製品とユーザ、レビューをノードとして登録し、関係性（「ユーザが製品を購入した」「レビューが製品について言及した」等）をエッジとしてモデル化すれば、あるユーザが高く評価している特徴を持つ製品をグラフ経由で探索するといった高度なクエリが書けます。Azure Database for PostgreSQLへのApache AGE導入により、**リレーショナルとグラフの統合**が容易になり、別サービスを併用するコストも削減できます。

以上の3つの拡張機能を組み合わせることで、Azure Database for PostgreSQLは以下のような強力な機能を備えます。

- SQLで直接LLMに質問・文章生成をさせたり、テキストの分析結果を取得できる（azure_ai）。
- 埋め込みベクトルを扱うことで意味ベースの検索（類義語や関連コンテキストを考慮した検索）が可能になる（pgvector）。
- 従来の行・列データに加えてノード・エッジ形式のデータを保持し、パス探索など関係性のクエリを実行できる（AGE）。

本ハンズオンのシナリオ（ショッピングサイト）では、**製品説明文やレビューをベクトル化**しておき検索に利用し、**LLMを使った検索結果の関連度評価（リランキング）や要約**を行い、さらに**製品・レビュー・特徴キーワードをグラフ化**して複雑な質問に答える——といった流れを全てPostgreSQL上で実現しています。データがすべて同一のPostgreSQL内に収まり、AI推論呼び出しもデータベース層で行えるため、シンプルで一貫したアプリケーション構成になっているのがポイントです。

## 拡張機能を有効化する手順

それでは、上記拡張をAzure Database for PostgreSQLで利用可能にする手順を概説します。それぞれPostgreSQLサーバー側で**拡張の有効化（インストール）**を行う必要があります。

### azure_ai拡張の有効化手順

1. **拡張の許可リスト追加**: Azure Database for PostgreSQLでは、カスタム拡張を使う際にサーバーパラメータ`azure.extensions`にその拡張名を登録する必要があります。Azure Portalの「サーバー パラメーター」設定画面かAzure CLIを使って、当該PostgreSQLサーバーの許可リストに`azure_ai`を追加します。追加後、`SHOW azure.extensions;`コマンドで反映されたか確認してください。

2. **拡張のインストール (DBごと)**: 許可リスト設定後、対象のPostgreSQLデータベースに接続し、次のSQLを実行します。

```sql
CREATE EXTENSION IF NOT EXISTS azure_ai;
```

データベースごとに上記コマンドを実行する必要があります（複数データベースで使いたい場合、それぞれで実行）。

3. **認証情報の設定**: `azure_ai`拡張がインストールされると、Azure OpenAIやCognitive Servicesを呼び出すためのエンドポイントURLやAPIキーを設定する関数群が利用できます。例えば、Azure OpenAIの場合はデータベース内の関数 `azure_openai.set_openai_endpoint('エンドポイントURL')` や `azure_openai.set_openai_key('キー')` のようなコマンドで、自分のAzure OpenAIリソースのHTTPエンドポイントとAPIキーを登録します。これらの設定値はデータベース内のテーブルに暗号化保存され、拡張機能の各種関数はこの設定を使ってAzureサービスを呼び出します。

> [!NOTE] 注意
> 本リポジトリのデプロイスクリプトでは、Azure OpenAIリソースの作成後に自動で上記設定関数を実行し、エンドポイントとキーをPostgreSQLに登録しています（手動で設定する必要はありません）。

### pgvector拡張の有効化手順

1. **拡張の許可リスト確認/追加**: pgvector拡張はPostgreSQLコミュニティ由来の拡張機能です。Azure Database for PostgreSQLでは多くの場合デフォルトで許可されていますが、念のため`SHOW azure.extensions;`で`vector`（※後述）拡張が含まれるか確認します。含まれていない場合は`azure_ai`と同様に許可リストに`vector`を追加します。

> [!NOTE] 注意
> 拡張名は`pgvector`ではなく`vector`として扱います。PostgreSQL上でも`CREATE EXTENSION vector;`と記述する点に注意してください。

2. **拡張のインストール**: データベースに接続し、以下のSQLを実行します。

```sql
CREATE EXTENSION IF NOT EXISTS vector;
```

これで`pgvector`が使えるようになります。インストール後は、ベクトル型（デフォルトでは`vector(1536)`など次元数指定した型）をテーブルで使ったり、`<=>`演算子が利用可能になります。

3. **ベクトル類似検索の利用**: 例えば、製品説明文から生成したベクトルを格納するカラム（例: `description_emb vector(1536)`）に対し、ユーザーの問い合わせ文から生成したベクトルとの距離を計算するクエリが書けます。距離計算には`<=>`という演算子を使い、値が小さいほど類似度が高いことを意味します。詳細な使用方法は後述の「ベクトルに対するクエリ」の項で説明します。

### Apache AGE拡張の有効化手順

1. **新規サーバであることの確認**: 前述の通り、Apache AGE拡張は既存のAzure Database for PostgreSQLサーバには導入できず、新しく作成したPG 13〜16対応サーバでのみプレビュー利用できます。`azd`によるデプロイではサーバ作成が自動で行われるため特別な操作は不要ですが、もし既存サーバに対して手動で導入する場合は、新たにサーバを作り直す必要があります。

2. **拡張の許可リスト追加**: サーバーパラメータの許可リストに`age`を追加します。Portalの場合「`AGE (preview)`」等の表記でON/OFFを切り替えられるかもしれません。

3. **拡張のインストール**: データベースで以下のSQLを実行します。

```sql
CREATE EXTENSION IF NOT EXISTS age CASCADE;
```

`CASCADE`オプションにより依存する`ag_catalog`スキーマ等も含めて作成されます。インストールが成功すると、グラフ操作用の関数群（特に`cypher()`関数）が使えるようになります。

4. **グラフの作成**: AGEではデータベース内にグラフを作成してからノード・エッジを追加します。グラフは論理的なコンテナ名で、例えば：

```sql
SELECT * FROM ag_catalog.create_graph('shop_graph');
```

のようにSQLから関数を呼ぶことで`shop_graph`という名のグラフを作成できます。あとはこのグラフ名を指定してノードやエッジを作成・クエリします。

5. **openCypherクエリの実行**: AGE拡張では、`cypher('グラフ名', $$ <Cypherクエリ> $$)`という関数呼び出しでCypherクエリを実行します。詳しくは後述の「グラフデータに対するクエリ」の項で例を示しますが、SQL文の中でサブクエリとしてCypherを呼び出し、その結果をテーブルのように取り扱うことができます。これにより、グラフの問い合わせ結果とリレーショナルなテーブルを結合することも容易にできます。

以上の手順によって、Azure Database for PostgreSQL上でAI・ベクトル・グラフの各機能が使えるようになります。本ハンズオンのデプロイスクリプトでは、デプロイ時に自動でこれら拡張の有効化SQLを実行する処理（`azd-hooks`のプリデプロイスクリプト）が組み込まれているため、参加者が手動でSQLを実行する必要はありません。ただし、仕組みを理解するために、Portal等で対象サーバの`azure.extensions`パラメータが設定され拡張がインストール済みになっていること、`azure_ai`や`age`スキーマがデータベース内に作成されていることなどを確認してみると良いでしょう。

[前へ](01-Introduction.md) | [次へ](03-Repository.md)
