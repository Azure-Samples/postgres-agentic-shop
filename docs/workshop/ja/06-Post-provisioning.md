# プロビジョニング後の確認ポイント

デプロイが完了したら、構築されたリソースやアプリケーションが正しく動作しているか確認します。本セクションでは**Azureポータル上で確認すべき主なリソース**と、それらの**役割**、および**アプリケーションの動作確認方法**について説明します。

## 主なAzureリソースとそれぞれの役割

デプロイされたリソースグループ内に、以下のような主要コンポーネントが存在するはずです。それぞれのリソースと、本ハンズオンアプリケーション内での役割を把握しておきましょう。

- **Azure Database for PostgreSQL (Flexible Server)**:
役割: アプリケーションのデータストア。リレーショナルデータ（ユーザ、製品、レビュー等）を保存するとともに、`azure_ai`・`pgvector`・`Apache AGE`拡張を利用したAI処理・ベクトル検索・グラフ分析を実行します。

確認内容: Azureポータルの「Azure Database for PostgreSQL」の項目で、新規サーバが作成されていることを確認します。設定->サーバーパラメータで`azure.extensions`に`azure_ai`,`vector`,`age`が含まれていること、接続情報（ホスト名、ユーザ名など）が想定通りか確認しましょう。データベースには初期データとして製品・レビュー情報がロードされているはずです（Arizeなど外部サービス接続情報もテーブルに含まれる可能性あり）。

- **Azure OpenAI リソース**:
役割: GPT-4などのモデルをホストする認知サービスリソース。PostgreSQL側からの`azure_ai`経由の呼び出しや、バックエンドコードからのAPI呼び出しに応答します。

確認内容: ポータルの「Azure OpenAI」から該当リソースを開き、モデルのデプロイ状況を確認します（「モデルのデプロイ」メニューで、例えば `gpt-4` や `text-embedding-ada-002` が Deploy 状態になっていればOKです）。また、キーとエンドポイントURIを確認し、PostgreSQL側に設定されたものと一致していることも後で検証できます。

- **バックエンド アプリ (例: Azure App Service または Function)**:
役割: Python製のアプリケーションロジックがデプロイされているホスティング環境です。ユーザーからの要求（例えば商品検索のクエリ）を受け取り、必要に応じてデータベースに問い合わせたりLLMエージェントを起動して応答を生成します。マルチエージェントのオーケストレーションが行われる中心的存在です。

確認内容: ポータルの「App Service」や「Function App」を確認し、新しく作成されたリソースを探します。ネーミングは環境名などが含まれているはずです。App Serviceの場合、「デプロイセンター」や「構成 > アプリケーション設定」を見て、データベース接続文字列やOpenAIエンドポイントなどが環境変数として設定されていることを確認しましょう。また、「ログストリーム」を有効にし、後述のアプリテスト時にログが出力されるかを見るのも有益です。

- **フロントエンド アプリ (例: Azure Static Web Apps あるいはStorageの静的サイト)**:
役割: ユーザーインターフェースをホストします。今回TypeScriptのコードが含まれていたため、おそらくReactやVue等のシングルページアプリ（SPA）がビルドされ、静的ファイルがデプロイされていると考えられます。ユーザーはこのフロントエンドを通じて検索クエリを入力したり結果を閲覧します。フロントエンドからバックエンドAPIへの呼び出しもここで行われます。

確認内容: Static Web Appsの場合、ポータルの対象リソースを開き、「URL」を確認します。このURLが後述の動作確認で使用するWebアプリのURLになります。Storageアカウントの静的サイトホスティングの場合、エンドポイント域名が表示されています。これらに実際にアクセスしてみて、ページが表示されるか確認します。

- **その他リソース**:
Application Insights / Log Analytics: ログ収集用に設定されている可能性があります。バックエンドのログがここに送られていれば、障害調査等で参照できます。

Virtual Network / NSG: データベースをセキュアにするためにVNet内に配置されている場合、そのネットワーク関連リソースがあるかもしれません。ただ、Azure Database for PostgreSQL Flexibleはパブリックアクセスでも構築できるので、テンプレート次第です。必要に応じて確認してください。

以上のリソースが揃って初めてアプリケーションは動作します。それぞれの役割を理解することで、万一問題が発生した場合にどのコンポーネントを調査すべきか判断しやすくなります。

## アプリケーションの動作確認

リソースのデプロイが完了したら、実際にアプリケーション（AgenticShop）が期待通り動いているかを確認しましょう。確認すべきポイントを順に説明します。

1. **フロントエンドへのアクセス**: 前述のフロントエンドURL（例: `https://<ランダム名>.azurestaticapps.net` やカスタムドメイン）をブラウザで開きます。AgenticShopのトップページが表示されるはずです。画面には検索バーやカテゴリ選択、もしくはチャットボット風のUIがあるかもしれません。デザインは電子ガジェットのショッピングサイトを模していると想定されます。

2. **製品情報の表示**: アプリ上で適当な操作をしてみます。例えば商品カテゴリーを選択すると、そのカテゴリの製品一覧やおすすめ商品が表示されるか確認します。AgenticShopではユーザプロファイルに基づくパーソナライズ機能 ￼があるため、ユーザがログインする仕組みや、デフォルトユーザとして何か固定のプロフィールがあるかもしれません。もしログイン機能があれば用意されたテストユーザでログインします（ドキュメントを確認）。

3. **検索とAI応答**: 検索バーに質問文を入力してみます（例：「音質が良くてバッテリー長持ちのヘッドフォンはありますか？」など）。入力して送信すると、バックエンドでLLMエージェントが動作し、PostgreSQLからベクトル検索で製品とレビューを取得し、Azure OpenAIで要約・応答を生成する一連のフローが実行されます。その結果、画面上に該当する製品のリストや説明が表示されたり、チャットボットの回答として「おすすめのヘッドフォンは○○です。それは…（理由）」のような出力が得られることを確認します。リランクの効果も確認してみましょう。同じ質問をした際に、単にキーワード検索する場合と比較してより関連性の高い結果が出ているか（例えばノイズキャンセルに関する言及がちゃんと評価されているか）を検証します。

4. **グラフ機能の検証**: いくつか複雑な質問を試してみます。例えば「軽くて防水機能があり、音質レビュー評価の高いヘッドフォンは？」といった複合条件の質問です。この質問は製品スペック上の特徴（軽量＝デザイン特徴、耐水＝機能特徴）と、レビュー内容（音質について高評価か）を組み合わせています。AgenticShopではデータベース内でこのような質問に答えるため、製品とレビューの特徴をグラフデータ化し、さらにLLMの判断も加えて結果を絞り込んでいます。画面上ではトップ3に該当する製品がリストアップされ、各製品の特徴サマリやレビュー要約が表示されることを期待します。実際にそのような結果が得られれば、グラフ + AIが正しく機能している証拠です。

5. **デバッグパネルの確認（任意）**: Arize Phoenixによるデバッグパネル機能が含まれている場合、UI上に「Debug」や「Trace」といったボタンやリンクがあるかもしれません。それを開くと、エージェントの内部動作ログ（例えば各ステップでどんなクエリを発行し、どのような応答が得られたか、信頼度はどうか等）が一覧できる可能性があります。このパネルが利用できれば、ハンズオン参加者がエージェントの流れを追いやすくなるので、ぜひ一緒に確認してみてください。

以上のように、実際にアプリケーションを操作しながら各機能が期待通り動いているかテストします。特にデータベースの役割が正しく果たされているか（ベクトル検索結果が妥当か、グラフクエリが使われているか）は、Azure Portalの「クエリ パフォーマンス洞察」や`pg_stat_statements`拡張を見れば確認できるでしょう。興味があればバックエンドのログ（App Serviceの場合はLog StreamやApplication Insightsログ）も見てみましょう。Azure OpenAIに投げたプロンプトや応答内容、エラーがあればその内容などが記録されているはずです。

[前へ](05-Provisioning.md) | [次へ](07-WhyPostgreSQL.md)
